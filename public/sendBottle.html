<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/sendBottle.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- VueJS -->
    <script src="https://unpkg.com/vue@next"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>

    <!-- AXIOS FOR TELEGRAM HTTP GET REQUEST-->
    <script src="js/axios/axios.min.js"></script>
    <script src="js/users.js"></script>

    <title>Send bottle</title>
</head>

<body>
    <script>checkLoginStatus()</script>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-dark" style="position: sticky;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a id="navbar" class="nav-link active" aria-current="page" href="catchbottle.html">Bottle</a>
                    </li>
                    <li class="nav-item">
                        <a id="navbar" class="nav-link" href="sendBottle.html">Send Bottle</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a id="navbar" class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Profile
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="dropdown">
                            <div class="card" style="width: 15rem;">
                                <img src="img/test_profile.png" class="card-img-top" alt="...">
                                <div class="card-body">
                                    <p class="card-text" style="font-weight:bold;">
                                        wyf
                                        <script>
                                            sessionStorage.getItem("login_status")
                                        </script>
                                    </p>
                                </div>
                            </div>
                            <li><a class="dropdown-item" href="updateUser.html">Update User Info</a></li>
                            <li><a class="dropdown-item" href="#">Map Feature</a></li>
                            <li><input type="button" value="Logout" onclick="logout()"></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a id="navbar" class="nav-link" href="aboutUs.html">About Us</a>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <div id="app">
        <div class="container">
            <div class="row">
                <div class="col-md-6" id="write">
                    <form>
                        <div class="form-group">
                            <label for="exampleFormControlTextarea1">Type your message</label>
                            <div id="speechbutton" class="btn btn-success">speech recognition</div>
                            <div id="output"></div>
                            <textarea v-model="message" class="form-control" id="exampleFormControlTextarea1" rows="20"
                                maxlength="400"></textarea>
                        </div>
                        <span id='num-chars'>6</span> / 400
                        </br>
                        </br>
                        <div class="form-group">
                            <label for="exampleFormControlFile1">Attach an image</label>
                            <input type="file" class="form-control-file" id="exampleFormControlFile1">
                        </div>
                        <div class="text-right">
                            <button type="button" class="btn btn-primary mb-2"
                                onclick="generate(document.getElementById('exampleFormControlTextarea1').value)">Confirm</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6" id="text">
                    <p>{{message}}</p>
                    <p id="status"></p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        myObject = new Vue({
            el: '#app',
            data: {
                message: 'Hello!'
            }
        })
        var numChars = document.getElementById('num-chars');
        var textInput = document.getElementById('exampleFormControlTextarea1');
        textInput.addEventListener('keyup', doText);

        function doText(event) {
            var charLength = textInput.value.length;
            if (charLength > 380) {
                numChars.innerHTML = charLength;
                numChars.style.color = 'red';
            } else {
                numChars.innerHTML = charLength;
                numChars.style.color = 'black';
            }

        }
    </script>


    <script src="js/speechRecognition/speech.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
    <!-- This is the API from Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-database.js"></script>

    <script>
        // Config and Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDLM5eiv5cOkBtM-os59uGPAhtFkdBCAhY",
            authDomain: "sademo2018-2-11ec2.firebaseapp.com",
            databaseURL: "https://sademo2018-2-11ec2.firebaseio.com",
            projectId: "sademo2018-2-11ec2",
            storageBucket: "sademo2018-2-11ec2.appspot.com",
            messagingSenderId: "431393859582",
            appId: "1:431393859582:web:ccc0434dd68846b15b82af"
        };
        firebase.initializeApp(firebaseConfig);

        function sendTeleNotifHelper(chatID, from) {
            var BOTTOKEN = "2001239054:AAFHa2YyUb-8Y_T0NXt3J-_aRBDBrdgQrxI"
            var sendString = `${from} has written a bottle!!`;


            var sendURL = `https://api.telegram.org/bot${BOTTOKEN}/sendMessage?chat_id=${chatID}&text=${sendString}`;

            axios.get(sendURL, {
                    params: {}
                })
                .then(response => {
                    console.log("telegram sent!")
                })
                .catch(error => {
                    console.log("telegram error")
                })
        }

        function sendUserTelegram(targetUsername, from) {

            list_of_user = firebase.database().ref('users/');
            list_of_user.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    user_details = snapshot.val();
                    for (user in user_details) {
                        console.log(user);
                        telegram_info = user_details[user].telegram_info;
                        if (user === targetUsername) {
                            console.log(telegram_info);
                            sendTeleNotifHelper(telegram_info, from);

                        }
                    }
                }
            })
        }

        // create a bottle table in db
        // function createBottleTable() {
        //     firebase.database().ref('bottles/' + 'bottle0').set({
        //             from: 'wyf',
        //             message: 'initial singularity'
        //         }).then(function () {
        //             console.log("bottles created")
        //         })
        //         .catch(function (error) {
        //             console.log("bottles failed to be created")
        //         });
        // }
        // createBottleTable()

        // update the data in db
        if (sessionStorage.getItem("login_status") != null) {
            function generate(message) {
                var username = sessionStorage.getItem("login_status");
                console.log("updating" + username);
                var bottles = firebase.database().ref('bottles/');
                bottles.once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log("msg:" + message);

                        // count number of bottles
                        var bottles = snapshot.val();
                        console.log(bottles)
                        var count_msg = 0
                        for (bottle in bottles) {
                            // console.log(bottle)
                            // console.log(bottles[bottle])
                            if (bottle.includes('bottle')) {
                                count_msg++
                            }
                        }
                        console.log(count_msg)

                        //update data with new bottle name
                        var updates = {};
                        var bottle_name = "bottle" + count_msg
                        updates['/bottles/' + bottle_name + "/message"] = message;
                        updates['/bottles/' + bottle_name + "/from"] = username;
                        firebase.database().ref().update(updates);
                        document.getElementById("status").innerText = "Message Sent.";


                        //send to telegram
                        //sendUserTelegram("adam", username);

                        //notify all users in database
                        function notifyAllTelegram() {
                            var allusers = firebase.database().ref('users/');
                            allusers.once('value').then((snapshot) => {
                                console.log(snapshot.val());
                                for (user_info in snapshot.val()) {
                                    console.log(`sending to ${user_info}`);

                                    sendUserTelegram(user_info, username);
                                }

                            })
                        }

                        notifyAllTelegram();

                    } else {
                        document.getElementById("status").innerText = "User does not exist.";
                    }
                });
            }
        } else {
            window.location.href = 'index.html';
            alert("please login first!!");
        }
    </script>


    <footer class="bg-dark text-center text-white">
        <!-- Copyright -->
        <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
            © 2021 Copyright:
            <a class="text-white" href="https://mdbootstrap.com/">Team IDK</a>
        </div>
        <!-- Copyright -->
    </footer>










    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</body>

</html>